<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Map View Test</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      margin: 20px;
      min-width: 600px;
    }
    h1 { margin-bottom: 20px; }
    .test-section {
      margin-bottom: 20px;
      padding: 15px;
      border: 1px solid #ddd;
      border-radius: 8px;
    }
    .controls {
      display: flex;
      gap: 10px;
      margin-bottom: 15px;
    }
    input, button {
      padding: 8px 12px;
      font-size: 14px;
      border: 1px solid #ddd;
      border-radius: 4px;
    }
    button {
      cursor: pointer;
      background: #4CAF50;
      color: white;
      border: none;
    }
    button:hover { background: #45a049; }
    button:disabled { background: #ccc; cursor: not-allowed; }
    .status {
      padding: 10px;
      border-radius: 4px;
      margin-top: 10px;
    }
    .status.success { background: #e8f5e9; color: #2e7d32; }
    .status.error { background: #ffebee; color: #c62828; }
    .status.info { background: #e3f2fd; color: #1976D2; }
    #map {
      width: 100%;
      height: 400px;
      border: 1px solid #ddd;
      border-radius: 8px;
    }
    .address-list {
      max-height: 200px;
      overflow-y: auto;
      margin-top: 15px;
    }
    .address-item {
      padding: 8px;
      background: #f5f5f5;
      margin-bottom: 4px;
      border-radius: 4px;
      font-size: 13px;
    }
  </style>
  <link rel="stylesheet" href="lib/leaflet.css">
</head>
<body>
  <h1>Map View Test Page</h1>

  <div class="test-section">
    <h2>Address Search</h2>
    <div class="controls">
      <input type="text" id="searchInput" placeholder="Enter address (e.g., 1909 W Martha Ln, Santa Ana, CA)" style="flex: 1;">
      <button id="searchBtn">Search</button>
    </div>
    <div id="searchStatus" class="status" style="display: none;"></div>
  </div>

  <div class="test-section">
    <h2>Draw Zone</h2>
    <div class="controls">
      <button id="drawRectBtn">Draw Rectangle</button>
      <button id="drawCircleBtn">Draw Circle</button>
      <button id="undoBtn" disabled>Undo Last</button>
      <button id="clearBtn">Clear All</button>
    </div>
    <div id="drawStatus" class="status" style="display: none;"></div>
  </div>

  <div class="test-section">
    <h2>Map</h2>
    <div id="map"></div>
    <div class="controls" style="margin-top: 10px;">
      <span>Selected: <strong id="selectedCount">0</strong> addresses</span>
    </div>
    <div id="addressList" class="address-list"></div>
  </div>

  <script src="lib/leaflet.js"></script>
  <script type="module">
    // Mock chrome API
    window.chrome = {
      storage: {
        sync: {
          get: (_, callback) => callback?.({}),
          set: (_, callback) => callback?.()
        }
      },
      runtime: {
        sendMessage: () => {}
      }
    };

    // Import MapView
    import { MapView } from './modules/map-view.js';

    const PROXY_URL = 'http://localhost:3000';
    const DEFAULT_CENTER = [33.8, -117.8];

    // Initialize map
    const mapView = new MapView(document.getElementById('map'), {
      center: DEFAULT_CENTER,
      zoom: 14,
      proxyUrl: PROXY_URL
    });

    // UI Elements
    const searchInput = document.getElementById('searchInput');
    const searchBtn = document.getElementById('searchBtn');
    const searchStatus = document.getElementById('searchStatus');
    const drawRectBtn = document.getElementById('drawRectBtn');
    const drawCircleBtn = document.getElementById('drawCircleBtn');
    const undoBtn = document.getElementById('undoBtn');
    const clearBtn = document.getElementById('clearBtn');
    const drawStatus = document.getElementById('drawStatus');
    const selectedCount = document.getElementById('selectedCount');
    const addressList = document.getElementById('addressList');

    let selectedAddresses = [];

    // Show status message
    function showStatus(element, message, type) {
      element.textContent = message;
      element.className = 'status ' + type;
      element.style.display = 'block';
      setTimeout(function() {
        element.style.display = 'none';
      }, 5000);
    }

    // Update UI
    function updateUI() {
      selectedCount.textContent = selectedAddresses.length;
      undoBtn.disabled = selectedAddresses.length === 0 || !mapView.markers;

      // Render address list safely
      while (addressList.firstChild) {
        addressList.removeChild(addressList.firstChild);
      }
      if (selectedAddresses.length === 0) {
        const item = document.createElement('div');
        item.className = 'address-item';
        item.textContent = 'No addresses selected. Click on the map or draw a zone.';
        addressList.appendChild(item);
      } else {
        selectedAddresses.forEach(function(addr, i) {
          const item = document.createElement('div');
          item.className = 'address-item';
          item.textContent = (i + 1) + '. ' + addr.full;
          addressList.appendChild(item);
        });
      }
    }

    // Address select callback
    mapView.onAddressSelect = function(address) {
      selectedAddresses.push(address);
      updateUI();
      showStatus(drawStatus, 'Added: ' + address.full, 'success');
    };

    // Zone select callback
    mapView.onZoneSelect = function(addresses) {
      selectedAddresses = selectedAddresses.concat(addresses);
      updateUI();
      showStatus(drawStatus, 'Found ' + addresses.length + ' addresses in zone', 'success');
    };

    // Search button
    searchBtn.addEventListener('click', async function() {
      const query = searchInput.value.trim();
      if (!query) {
        showStatus(searchStatus, 'Please enter an address', 'error');
        return;
      }

      searchBtn.disabled = true;
      searchBtn.textContent = 'Searching...';

      try {
        const result = await mapView.goToAddress(query);
        if (result) {
          showStatus(searchStatus, 'Found: ' + result.display_name, 'success');
        } else {
          showStatus(searchStatus, 'Address not found', 'error');
        }
      } catch (error) {
        showStatus(searchStatus, 'Error: ' + error.message, 'error');
      } finally {
        searchBtn.disabled = false;
        searchBtn.textContent = 'Search';
      }
    });

    // Draw rectangle button
    drawRectBtn.addEventListener('click', function() {
      if (mapView.isInDrawMode()) {
        mapView.disableDrawMode();
        drawRectBtn.classList.remove('active');
        drawCircleBtn.classList.remove('active');
        showStatus(drawStatus, 'Draw mode disabled', 'info');
      } else {
        mapView.enableRectangleDraw();
        drawRectBtn.classList.add('active');
        drawCircleBtn.classList.remove('active');
        showStatus(drawStatus, 'Click two corners to draw a rectangle', 'info');
      }
    });

    // Draw circle button
    drawCircleBtn.addEventListener('click', function() {
      if (mapView.isInDrawMode()) {
        mapView.disableDrawMode();
        drawRectBtn.classList.remove('active');
        drawCircleBtn.classList.remove('active');
        showStatus(drawStatus, 'Draw mode disabled', 'info');
      } else {
        mapView.enableCircleDraw();
        drawCircleBtn.classList.add('active');
        drawRectBtn.classList.remove('active');
        showStatus(drawStatus, 'Click center, then click edge for radius', 'info');
      }
    });

    // Undo button
    undoBtn.addEventListener('click', function() {
      mapView.undoLastMarker();
      if (selectedAddresses.length > 0) {
        selectedAddresses.pop();
        updateUI();
      }
    });

    // Clear button
    clearBtn.addEventListener('click', function() {
      mapView.clearMarkers();
      mapView.clearDrawings();
      selectedAddresses = [];
      updateUI();
      showStatus(drawStatus, 'Cleared all addresses', 'info');
    });

    // Initial UI update
    updateUI();

    // Check proxy server
    fetch(PROXY_URL + '/api/health')
      .then(function(r) { return r.json(); })
      .then(function() { showStatus(searchStatus, 'Proxy server connected', 'success'); })
      .catch(function() { showStatus(searchStatus, 'Proxy server not running on port 3000', 'error'); });
  </script>
</body>
</html>
